# Security Review: joshkurz.net

| Field | Value |
|-------|-------|
| Reviewed | 2026-03-01 |
| Commit | `4876c041f91ca9ae8263a465ed04ace50620c0ea` |
| Commit date | 2026-03-01 20:51:37 -0500 |
| Commit message | Fix critical security issues from 2026-02-28 security review |
| Reviewer | Claude (well-architected-security skill) |

---

## ðŸ”´ Critical Vulnerabilities

None. The critical issues from the 2026-02-28 review have been resolved.

---

## ðŸŸ¡ Security Weaknesses

### 1. Rate limiting is still absent â€” financial DoS still open

`vercel.json` sets `maxDuration: 30` for `ai-joke`, `speak`, and `custom-jokes`. This caps how long a single invocation can run, but does **not** limit how many requests can be made. A loop of POST requests still drains OpenAI credits with zero friction:

```bash
while true; do curl -s -X POST https://joshkurz.net/api/ai-joke; done
```

`maxDuration` prevents one slow request from hanging, but 1000 fast ones still fire 1000 OpenAI calls. The actual rate-limit fix â€” per-IP throttling â€” is still missing and requires Vercel WAF (Pro plan, dashboard-configured) or Edge Middleware code.

**Fix:** Add Next.js Edge Middleware (`middleware.js` at project root) with a simple in-memory or Upstash Redis token bucket on the three cost-incurring routes, or enable Vercel Firewall rules.

---

### 2. `jokeId` accepts unbounded length in both GET and POST `/api/ratings`

`pages/api/ratings.js:26-27` (GET), `pages/api/ratings.js:56-57` (POST):
```js
if (!jokeId || typeof jokeId !== 'string') {
  res.status(400).json({ error: 'Missing jokeId' })
```

`jokeId` is validated as a string but has no length limit. It flows directly into a DynamoDB key:
```js
PK: `JOKE#${jokeId}`,       // ratings write â€” lib/ratingsStorageDynamo.js:16
Key: { PK: `STATS#${jokeId}`, SK: 'AGGREGATE' }  // stats read â€” lib/ratingsStorageDynamo.js:41
```

DynamoDB silently rejects keys over 2KB, producing a 500 error that looks like an infrastructure failure. A 50KB `jokeId` passes JS validation and makes a round-trip to AWS before failing.

**Fix:**
```js
if (!jokeId || typeof jokeId !== 'string' || jokeId.length > 200) {
  res.status(400).json({ error: 'Invalid jokeId' })
  return
}
```

---

### 3. No HTTP security headers

`next.config.js` sets only `reactStrictMode: true`. No security headers are configured. Missing:

| Header | Risk without it |
|--------|----------------|
| `X-Frame-Options: DENY` | Clickjacking â€” site can be embedded in an `<iframe>` on an attacker page |
| `X-Content-Type-Options: nosniff` | MIME sniffing attacks on served content |
| `Referrer-Policy: strict-origin-when-cross-origin` | Leaks full URL in Referer header to third-party requests |
| `Content-Security-Policy` | Defense-in-depth against XSS (currently clean, but no belt-and-suspenders) |

**Fix** â€” add to `next.config.js`:
```js
async headers() {
  return [{
    source: '/(.*)',
    headers: [
      { key: 'X-Frame-Options', value: 'DENY' },
      { key: 'X-Content-Type-Options', value: 'nosniff' },
      { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
    ]
  }]
}
```

---

### 4. `fast-xml-parser` â€” GHSA-fj3w-jwp8-x2g3 (stack overflow in XMLBuilder)

Via `@aws-sdk/xml-builder` â†’ `@aws-sdk/client-dynamodb`. Not user-triggerable without controlling AWS API responses, but it is a flagged CVE in a production dependency. Fix requires `npm audit fix --force` which upgrades `@aws-sdk/client-dynamodb` to a new major version (breaking change).

---

### 5. Next.js 13.0.6 â€” 11 CVEs

Notable CVEs: `GHSA-f82v-jwr5-mffw` (authorization bypass in middleware), `GHSA-7gfc-8cq8-jh5f` (authorization bypass), `GHSA-4342-x723-ch2f` (SSRF via middleware redirect), `GHSA-c59h-r6p8-q9wc` (cache-control missing header via CDN).

**Actual exposure:** This app uses Next.js pages router only â€” no middleware, no image optimization, no server actions, no RSC. The middleware CVEs (`GHSA-f82v-jwr5-mffw`, `GHSA-4342-x723-ch2f`) require a `middleware.js` to be present, which doesn't exist. Image optimization CVEs require the `<Image>` component or `/_next/image` route to be in use. Risk for this specific app is low, but the version is severely out of date (13.0.6, current is 15+) and should be upgraded.

---

## ðŸŸ¢ Security Wins

- **No hardcoded secrets** â€” all credentials via `process.env`, clean secret scan
- **`.gitignore`** now covers `.env` and `.env.*` with `!.env.example` carve-out
- **`/api/speak`** â€” POST-only, 500-char text cap before billing OpenAI, voice allowlist with silent default
- **`JokeSpeaker`** â€” switched from GET `src` attribute to `fetch POST` + blob URL; eliminates the third-party-embeddable TTS call vector
- **`/api/ratings`** â€” joke â‰¤1000 chars, author â‰¤200 chars, rating is strict integer 1â€“5, jokeId type-checked
- **`/api/custom-jokes`** â€” 3â€“500 char limits on all three fields, type-checked, sanitized, trimmed
- **`/api/ai-joke`** â€” POST-only, accepts no user input, generates server-side
- **All DynamoDB expressions parameterized** â€” `ExpressionAttributeValues` throughout, zero string concatenation into key conditions
- **No `dangerouslySetInnerHTML`** â€” XSS surface clean across all pages and components
- **AI content moderation** on user joke submissions before storage
- **`vercel.json`** caps function execution time at 30s for all three cost-incurring endpoints

---

## Immediate Actions Required

1. **Add `jokeId` length cap to `/api/ratings`** â€” 2-line fix, prevents spurious DynamoDB errors and unnecessary AWS round-trips
2. **Add HTTP security headers to `next.config.js`** â€” 10-line fix, closes clickjacking and MIME sniffing

---

## Security Hardening Backlog

- Implement actual per-IP rate limiting via Edge Middleware or Vercel WAF â€” rate limiting remains the only unaddressed financial DoS vector
- Upgrade Next.js (13 â†’ 15+) to clear 11 CVEs â€” separate PR, likely some pages-router API changes needed
- Upgrade AWS SDK (`npm audit fix --force`) to clear `fast-xml-parser` CVE â€” test DynamoDB operations thoroughly after upgrading
