# Security Review: joshkurz.net

| Field | Value |
|-------|-------|
| Reviewed | 2026-03-01 |
| Commit | `522b0ed8169d8e63292ace55d51fd3997058ff15` |
| Commit date | 2026-03-01 21:20:25 -0500 |
| Commit message | Upgrade Next.js 13â†’15, add dependency-watch skill |
| Reviewer | Claude (well-architected-security skill) |

---

## ðŸ”´ Critical Vulnerabilities

None.

---

## ðŸŸ¡ Security Weaknesses

### 1. GHSA-fj3w-jwp8-x2g3 â€” `fast-xml-parser` stack overflow via `@aws-sdk/xml-builder` (STILL OPEN)

```
@aws-sdk/xml-builder@3.972.8 â†’ fast-xml-parser@5.3.6   (installed)
Safe threshold: fast-xml-parser >= 5.3.8
Latest fast-xml-parser: 5.4.1
```

`@aws-sdk/xml-builder` is pinned to `fast-xml-parser@5.3.6` â€” two patch versions behind the fix. The CVE is a stack overflow in `XMLBuilder` triggered via malicious XML with `preserveOrder` enabled. Not user-triggerable without controlling AWS API responses, but it is a flagged production dependency CVE. AWS SDK upstream has not yet updated their pinned version.

**Status: STILL OPEN â€” monitor for AWS SDK patch.**

---

### 2. `middleware.js` rate-limit Map is unbounded

`middleware.js:12`
```js
const log = new Map()
```

The Map grows by one entry per unique IP seen. Entries are pruned of old _timestamps_ on each access, but the IP key itself is never evicted â€” a Map entry with an empty array remains indefinitely. On a long-running Edge worker handling traffic from many unique IPs this accumulates memory over time.

Low risk on Vercel (Edge workers restart regularly), but worth knowing. Fix: add a `log.delete(ip)` when `timestamps` becomes empty after pruning.

---

### 3. `middleware.js` IP fallback degrades rate limiting

`middleware.js:14-19`
```js
function getIp(request) {
  return (
    request.headers.get('x-forwarded-for')?.split(',')[0].trim() ||
    request.headers.get('x-real-ip') ||
    'unknown'
  )
}
```

If both headers are absent, all requests share the `'unknown'` bucket. On Vercel, `x-forwarded-for` is always set, so real risk is near zero. But if Vercel's header injection ever fails, the single shared bucket would hit the per-IP limit immediately for all users. Defensive fix: return `null` and skip rate-limiting when IP is indeterminate.

---

## ðŸŸ¢ Security Wins

- **No hardcoded secrets** â€” clean scan across all `pages/` and `lib/`
- **`.gitignore`** covers `.env` and `.env.*`, `!.env.example` carve-out
- **Rate limiting** â€” per-IP sliding-window middleware on all three cost-incurring endpoints (10/min on `ai-joke`+`speak`, 5/min on `custom-jokes`)
- **`/api/speak`** â€” POST-only, 500-char text cap, voice allowlist
- **`/api/ratings`** â€” `jokeId` â‰¤200 chars on GET and POST, `joke` â‰¤1000 chars, `author` â‰¤200 chars, rating strict integer 1â€“5
- **`/api/custom-jokes`** â€” 3â€“500 char limits, type-checked, sanitized, AI content moderation before storage
- **`/api/ai-joke`** â€” POST-only, no user input, AI-generated content only
- **All DynamoDB expressions parameterized** â€” `ExpressionAttributeValues` throughout, zero injection surface
- **No `dangerouslySetInnerHTML`** â€” XSS surface clean across all pages and components
- **HTTP security headers** â€” `X-Frame-Options: DENY`, `X-Content-Type-Options: nosniff`, `Referrer-Policy: strict-origin-when-cross-origin` on all routes
- **Next.js 15.5.12** â€” all 11 Next.js CVEs cleared by upgrade from 13.0.6
- **`vercel.json`** â€” `maxDuration: 30` on cost-incurring functions

---

## Immediate Actions Required

None â€” no critical or high-severity issues exist.

---

## Security Hardening Backlog

- **AWS SDK `fast-xml-parser` patch** â€” monitor `@aws-sdk/xml-builder` releases; upgrade when it pins `fast-xml-parser >= 5.3.8`. Run `/dependency-watch` to check.
- **`middleware.js` Map eviction** â€” delete IP entries when their timestamp array empties
- **`middleware.js` unknown-IP handling** â€” skip rate limiting rather than using shared `'unknown'` bucket when IP is indeterminate

---

## Dependency Watch

### 2026-03-01

**GHSA-fj3w-jwp8-x2g3 â€” fast-xml-parser stack overflow via @aws-sdk/xml-builder**
- Status: **STILL OPEN**
- `@aws-sdk/xml-builder@latest` uses: `fast-xml-parser@5.3.6`
- Safe threshold: `>= 5.3.8`
- Latest `fast-xml-parser`: `5.4.1`
- `npm audit`: still flagged (20 low severity vulnerabilities, all in AWS SDK chain)
- Action: No change needed â€” AWS SDK has not yet updated their pinned version. Re-check with `/dependency-watch` after next AWS SDK release.
